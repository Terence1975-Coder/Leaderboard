<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rob's Cornwall Business Contact Tracker v3</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .export-btn { background: #27ae60; color: white; }
        .export-btn:hover { background: #219a52; transform: translateY(-2px); }

        .upload-btn { background: #9b59b6; color: white; }
        .upload-btn:hover { background: #8e44ad; transform: translateY(-2px); }

        .save-btn { background: #2ecc71; color: white; }
        .save-btn:hover { background: #27ae60; transform: translateY(-2px); }

        .load-btn { background: #3498db; color: white; }
        .load-btn:hover { background: #2980b9; transform: translateY(-2px); }

        .print-btn { background: #34495e; color: white; }
        .print-btn:hover { background: #2c3e50; transform: translateY(-2px); }

        .clear-btn { background: #e74c3c; color: white; }
        .clear-btn:hover { background: #c0392b; transform: translateY(-2px); }

        .more-btn { background: #9b59b6; color: white; }
        .more-btn:hover { background: #8e44ad; transform: translateY(-2px); }

        .more-button-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
        }

        .sector {
            margin: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .grid-container {
            padding: 20px;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 40px 150px 120px 200px 180px 200px 250px 120px;
            gap: 10px;
            padding: 15px 10px;
            background: #34495e;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-align: center;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 40px 150px 120px 200px 180px 200px 250px 120px;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .actions-row {
            display: grid;
            grid-template-columns: 40px 120px 120px 120px 150px auto;
            gap: 10px;
            padding: 8px 10px;
            background-color: #f1f2f6;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
        }

        .actions-row.no-border {
            border-bottom: none;
        }

        .contact-field {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .contact-field input {
            flex: 1;
        }

        .copy-btn {
            padding: 4px 8px;
            font-size: 0.7em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #95a5a6;
            color: white;
            min-width: 40px;
        }

        .copy-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: #27ae60;
            transform: scale(1.1);
        }

        .grid-row.no-border {
            border-bottom: none;
        }

        .notes-row {
            display: grid;
            grid-template-columns: 40px auto 1fr;
            gap: 10px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
        }

        .notes-row.no-border {
            border-bottom: none;
        }

        .email-buttons {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .grid-row:nth-child(3n+1) { background-color: #ffffff; }
        .grid-row:nth-child(3n+2) { background-color: #f8f9fa; }
        .grid-row:nth-child(3n) { background-color: #ffffff; }

        /* Outcome color coding */
        .outcome-confirmed { 
            border: 3px solid #27ae60 !important; 
            background-color: rgba(39, 174, 96, 0.1) !important; 
        }
        .outcome-rejected { 
            border: 3px solid #e74c3c !important; 
            background-color: rgba(231, 76, 60, 0.1) !important; 
        }
        .outcome-interview { 
            border: 3px solid #3498db !important; 
            background-color: rgba(52, 152, 219, 0.1) !important; 
        }
        .outcome-waitlist { 
            border: 3px solid #f39c12 !important; 
            background-color: rgba(243, 156, 18, 0.1) !important; 
        }
        .outcome-pending { 
            border: 3px solid #9b59b6 !important; 
            background-color: rgba(155, 89, 182, 0.1) !important; 
        }
        .outcome-no-response { 
            border: 3px solid #7f8c8d !important; 
            background-color: rgba(127, 140, 141, 0.1) !important; 
        }

        .grid-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
        }

        .grid-cell input, .grid-cell select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .grid-cell input:focus, .grid-cell select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-bootcamp { background: #8e44ad; color: white; }
        .btn-bootcamp:hover { background: #7d3c98; }

        .btn-email { background: #2ecc71; color: white; }
        .btn-email:hover { background: #27ae60; }

        .btn-call { background: #f39c12; color: white; }
        .btn-call:hover { background: #e67e22; }

        .btn-visit { background: #e74c3c; color: white; }
        .btn-visit:hover { background: #c0392b; }

        .outcome-select {
            font-weight: 600;
            color: #2c3e50;
            width: 100%;
        }

        .outcome-select option[value="Confirmed"] { color: #27ae60; }
        .outcome-select option[value="Rejected"] { color: #e74c3c; }
        .outcome-select option[value="Interview"] { color: #3498db; }
        .outcome-select option[value="Waitlist"] { color: #f39c12; }
        .outcome-select option[value="Pending"] { color: #9b59b6; }
        .outcome-select option[value="No Response"] { color: #7f8c8d; }

        /* Dashboard Styles */
        .dashboard {
            margin: 0;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard-header h2 {
            font-size: 2em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .stat-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ecf0f1;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }

        .stat-number {
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            color: #3498db;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stat-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-breakdown > div {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-breakdown > div:last-child {
            border-bottom: none;
        }

        .stat-breakdown span {
            font-weight: 600;
            color: #3498db;
        }

        .outcome-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 500;
        }

        .outcome-stat:last-child {
            border-bottom: none;
        }

        .outcome-stat.confirmed { color: #2ecc71; }
        .outcome-stat.rejected { color: #e74c3c; }
        .outcome-stat.interview { color: #3498db; }
        .outcome-stat.waitlist { color: #f39c12; }
        .outcome-stat.pending { color: #9b59b6; }
        .outcome-stat.no-response { color: #95a5a6; }

        .outcome-stat span {
            color: inherit !important;
            font-weight: 700;
        }

        .success-rate {
            text-align: center;
        }

        .rate-label {
            font-size: 1em;
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .rate-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #2ecc71;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .rate-details {
            color: #bdc3c7;
            font-size: 0.8em;
        }

        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .firebase-connected {
            background: #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3);
        }

        .firebase-disconnected {
            background: #e74c3c;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }

        .firebase-saving {
            background: #f39c12;
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
        }

        @media (max-width: 768px) {
            .grid-header, .grid-row, .actions-row {
                grid-template-columns: 1fr;
                text-align: left;
            }
            
            .grid-cell {
                justify-content: flex-start;
                margin-bottom: 10px;
            }
        }

        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .controls { display: none; }
            .btn-small { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rob's Cornwall Business Contact Tracker v3</h1>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Contact Activity Dashboard</h2>
                <div id="filter-indicator" style="font-size: 1.2em; margin-top: 10px; color: #3498db; font-weight: 600;"></div>
            </div>
            <div class="dashboard-content">
                <div class="stats-grid">
                    <!-- Active Contacts -->
                    <div class="stat-card">
                        <div class="stat-title">Active Contacts</div>
                        <div class="stat-number" id="active-contacts">0</div>
                    </div>

                    <!-- Bootcamp Stats -->
                    <div class="stat-card">
                        <div class="stat-title">Bootcamp Types</div>
                        <div class="stat-breakdown">
                            <div>Bootcamp: <span id="bootcamp-count">0</span></div>
                            <div>Prince 2: <span id="prince2-count">0</span></div>
                            <div>AI: <span id="ai-count">0</span></div>
                            <div>Microsoft: <span id="microsoft-count">0</span></div>
                        </div>
                    </div>

                    <!-- Communication Stats -->
                    <div class="stat-card">
                        <div class="stat-title">Communications</div>
                        <div class="stat-breakdown">
                            <div>Emails Sent: <span id="emails-sent">0</span></div>
                            <div>Calls Made: <span id="calls-made">0</span></div>
                        </div>
                    </div>

                    <!-- Outcomes Stats -->
                    <div class="stat-card">
                        <div class="stat-title">Outcomes</div>
                        <div class="stat-breakdown">
                            <div class="outcome-stat confirmed">Confirmed: <span id="confirmed-count">0</span></div>
                            <div class="outcome-stat rejected">Rejected: <span id="rejected-count">0</span></div>
                            <div class="outcome-stat interview">Interview: <span id="interview-count">0</span></div>
                            <div class="outcome-stat waitlist">Waitlist: <span id="waitlist-count">0</span></div>
                            <div class="outcome-stat pending">Pending: <span id="pending-count">0</span></div>
                            <div class="outcome-stat no-response">No Response: <span id="no-response-count">0</span></div>
                        </div>
                    </div>

                    <!-- Completion Stats -->
                    <div class="stat-card">
                        <div class="stat-title">Data Completion</div>
                        <div class="stat-breakdown">
                            <div>With Email: <span id="with-email">0</span></div>
                            <div>With Phone: <span id="with-phone">0</span></div>
                            <div>With Notes: <span id="with-notes">0</span></div>
                            <div>Complete Profiles: <span id="complete-profiles">0</span></div>
                        </div>
                    </div>

                    <!-- Success Rate -->
                    <div class="stat-card">
                        <div class="stat-title">Success Metrics</div>
                        <div class="success-rate">
                            <div class="rate-label">Success Rate</div>
                            <div class="rate-number" id="success-rate">0%</div>
                            <div class="rate-details">
                                <small>Confirmed + Interview / Total Outcomes</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="uploadCSV(event)">
            <button onclick="document.getElementById('csvUpload').click()" class="btn upload-btn">Upload CSV</button>
            <button onclick="exportAllToCSV()" class="btn export-btn">Export All to CSV</button>
            <button onclick="saveToFirebase()" class="btn save-btn">Save to Cloud</button>
            <button onclick="loadFromFirebase()" class="btn load-btn">Load from Cloud</button>
            <button onclick="window.print()" class="btn print-btn">Print All</button>
            <button onclick="clearAllData()" class="btn clear-btn">Clear All Data</button>
        </div>

        <!-- Sort Controls -->
        <div class="controls" style="background: #e9ecef;">
            <select id="filter-saleslead" class="btn" style="background: #e67e22; color: white;" onchange="applyFilter()">
                <option value="">Show All Sales Leads</option>
            </select>
            <button onclick="updateSalesLeadFilter()" class="btn" style="background: #16a085; color: white;">Refresh Filter</button>
            <select id="sort-field" class="btn" style="background: #9b59b6; color: white;">
                <option value="">Select Field</option>
                <option value="saleslead">Sales Lead</option>
                <option value="industry">Industry</option>
                <option value="company">Company Name</option>
                <option value="contact">Contact Person</option>
                <option value="email">Email</option>
                <option value="outcome">Outcome</option>
            </select>
            <button onclick="sortData()" class="btn" style="background: #27ae60; color: white;">Apply Sort</button>
            <button onclick="resetView()" class="btn" style="background: #e74c3c; color: white;">Show All Rows</button>
        </div>

        <!-- Firebase Status Indicator -->
        <div id="firebase-status" class="firebase-status firebase-disconnected">
            🔴 Firebase Disconnected
        </div>

        <!-- Tourism & Hospitality Sector -->
        <div class="sector">
            <div class="grid-container">
                <div class="grid-header">
                    <div>#</div>
                    <div>Sales Lead</div>
                    <div>Industry</div>
                    <div>Company Name</div>
                    <div>Contact Person</div>
                    <div>Phone Number</div>
                    <div>Email Address</div>
                    <div>Region</div>
                </div>
                <div id="tourism-grid"></div>
                <div class="more-button-container">
                    <button onclick="addMoreRows('tourism')" class="btn more-btn" id="tourism-more-btn">More</button>
                </div>
                <div id="tourism-extra-grid" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
            authDomain: "prospecting-f2f42.firebaseapp.com",
            databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "prospecting-f2f42",
            storageBucket: "prospecting-f2f42.firebasestorage.app",
            messagingSenderId: "292034226428",
            appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
            measurementId: "G-WWB0JTX2L2"
        };

        // Initialize Firebase
        let database = null;
        let firebaseApp = null;

        function initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                updateFirebaseStatus('connected');
                console.log('Firebase initialized successfully');
                
                // Auto-load data on startup
                loadFromFirebase();
                
                // Set up auto-save every 30 seconds
                setInterval(autoSaveToFirebase, 30000);
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                updateFirebaseStatus('disconnected');
                alert('Firebase connection failed. Please check your configuration.');
            }
        }

        function updateFirebaseStatus(status) {
            const statusElement = document.getElementById('firebase-status');
            if (status === 'connected') {
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.innerHTML = '🟢 Firebase Connected';
            } else if (status === 'saving') {
                statusElement.className = 'firebase-status firebase-saving';
                statusElement.innerHTML = '🟡 Saving to Cloud...';
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '🔴 Firebase Disconnected';
            }
        }

        function getAllData() {
            const allData = { tourism: {} };

            // Check both main grid (1-100) and extra grid (101-120)
            for (let i = 1; i <= 120; i++) {
                const salesLead = document.getElementById(`tourism-saleslead-${i}`)?.value || '';
                const industry = document.getElementById(`tourism-industry-${i}`)?.value || '';
                const company = document.getElementById(`tourism-company-${i}`)?.value || '';
                const contact = document.getElementById(`tourism-contact-${i}`)?.value || '';
                const phone = document.getElementById(`tourism-phone-${i}`)?.value || '';
                const email = document.getElementById(`tourism-email-${i}`)?.value || '';
                const region = document.getElementById(`tourism-region-${i}`)?.value || '';
                const notes = document.getElementById(`tourism-notes-${i}`)?.value || '';

                // Get button states
                const bootcampBtn = document.querySelector(`#tourism-bootcamp-${i}`);
                const emailBtn = document.querySelector(`#tourism-email-btn-${i}`);
                const callBtn = document.querySelector(`#tourism-call-btn-${i}`);
                const outcomeSelect = document.querySelector(`#tourism-outcome-${i}`);

                allData.tourism[i] = {
                    salesLead,
                    industry,
                    company,
                    contact,
                    phone,
                    email,
                    region,
                    notes,
                    bootcamp: bootcampBtn?.textContent || 'Bootcamp',
                    emailStatus: emailBtn?.textContent || 'Send',
                    callStatus: callBtn?.textContent || 'Call',
                    outcome: outcomeSelect?.value || ''
                };
            }

            return allData;
        }

        function saveToFirebase() {
            if (!database) {
                alert('Firebase not connected. Please check your configuration.');
                return;
            }

            updateFirebaseStatus('saving');
            const allData = getAllData();
            const timestamp = new Date().toISOString();

            database.ref('cornwallBusinessTracker').set({
                data: allData,
                lastUpdated: timestamp,
                version: '3.0'
            }).then(() => {
                updateFirebaseStatus('connected');
                alert('Data saved to Firebase successfully!');
                console.log('Data saved to Firebase at:', timestamp);
            }).catch((error) => {
                updateFirebaseStatus('disconnected');
                alert('Failed to save to Firebase: ' + error.message);
                console.error('Firebase save error:', error);
            });
        }

        function autoSaveToFirebase() {
            if (!database) return;

            // Only auto-save if there's actual data
            const allData = getAllData();
            let hasData = false;
            
            Object.values(allData.tourism).forEach(row => {
                if (row.company || row.contact) {
                    hasData = true;
                }
            });

            if (hasData) {
                updateFirebaseStatus('saving');
                const timestamp = new Date().toISOString();
                database.ref('cornwallBusinessTracker').update({
                    data: allData,
                    lastUpdated: timestamp
                }).then(() => {
                    updateFirebaseStatus('connected');
                    console.log('Auto-saved to Firebase at:', timestamp);
                    showSaveConfirmation();
                }).catch((error) => {
                    updateFirebaseStatus('disconnected');
                    console.error('Auto-save failed:', error);
                });
            }
        }

        function showSaveConfirmation() {
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-weight: 600;
                z-index: 1001;
                box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
                transition: all 0.3s ease;
            `;
            confirmation.textContent = '✓ Data Saved';
            document.body.appendChild(confirmation);
            
            setTimeout(() => {
                confirmation.style.opacity = '0';
                confirmation.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (confirmation.parentNode) {
                        confirmation.parentNode.removeChild(confirmation);
                    }
                }, 300);
            }, 2000);
        }

        function loadFromFirebase() {
            if (!database) {
                alert('Firebase not connected. Please check your configuration.');
                return;
            }

            database.ref('cornwallBusinessTracker').once('value').then((snapshot) => {
                const firebaseData = snapshot.val();
                if (!firebaseData || !firebaseData.data) {
                    console.log('No data found in Firebase');
                    return;
                }

                const data = firebaseData.data;

                if (data.tourism) {
                    for (let i = 1; i <= 120; i++) {
                        const rowData = data.tourism[i];
                        if (!rowData) continue;

                        // Fill form fields
                        const salesLeadInput = document.getElementById(`tourism-saleslead-${i}`);
                        const industryInput = document.getElementById(`tourism-industry-${i}`);
                        const companyInput = document.getElementById(`tourism-company-${i}`);
                        const contactInput = document.getElementById(`tourism-contact-${i}`);
                        const phoneInput = document.getElementById(`tourism-phone-${i}`);
                        const emailInput = document.getElementById(`tourism-email-${i}`);
                        const regionInput = document.getElementById(`tourism-region-${i}`);
                        const notesInput = document.getElementById(`tourism-notes-${i}`);

                        if (salesLeadInput) salesLeadInput.value = rowData.salesLead || '';
                        if (industryInput) industryInput.value = rowData.industry || '';
                        if (companyInput) companyInput.value = rowData.company || '';
                        if (contactInput) contactInput.value = rowData.contact || '';
                        if (phoneInput) phoneInput.value = rowData.phone || '';
                        if (emailInput) emailInput.value = rowData.email || '';
                        if (regionInput) regionInput.value = rowData.region || '';
                        if (notesInput) notesInput.value = rowData.notes || '';

                        // Set button states
                        const bootcampBtn = document.querySelector(`#tourism-bootcamp-${i}`);
                        const emailBtn = document.querySelector(`#tourism-email-btn-${i}`);
                        const callBtn = document.querySelector(`#tourism-call-btn-${i}`);
                        const outcomeSelect = document.querySelector(`#tourism-outcome-${i}`);

                        if (bootcampBtn && rowData.bootcamp) {
                            bootcampBtn.textContent = rowData.bootcamp;
                            const bootcampColors = { 'Bootcamp': '#8e44ad', 'Prince 2': '#e74c3c', 'AI': '#3498db', 'Microsoft': '#27ae60' };
                            bootcampBtn.style.background = bootcampColors[rowData.bootcamp] || '#8e44ad';
                        }

                        if (emailBtn && rowData.emailStatus) {
                            emailBtn.textContent = rowData.emailStatus;
                            emailBtn.style.background = rowData.emailStatus === 'Sent' ? '#f39c12' : '#2ecc71';
                        }

                        if (callBtn && rowData.callStatus) {
                            callBtn.textContent = rowData.callStatus;
                            callBtn.style.background = rowData.callStatus === 'Called' ? '#27ae60' : '#f39c12';
                        }

                        if (outcomeSelect && rowData.outcome) {
                            outcomeSelect.value = rowData.outcome;
                            updateOutcomeColor(outcomeSelect);
                        }
                    }
                }

                updateDashboard();
                alert(`Data loaded from Firebase successfully!\nLast updated: ${new Date(firebaseData.lastUpdated).toLocaleString()}`);
                console.log('Data loaded from Firebase:', firebaseData.lastUpdated);
                
                // Update sales lead filter after loading data
                updateSalesLeadFilter();

            }).catch((error) => {
                alert('Failed to load from Firebase: ' + error.message);
                console.error('Firebase load error:', error);
            });
        }

        // Initialize the grids with empty rows for data entry
        function initializeGrids() {
            const grid = document.getElementById('tourism-grid');
            for (let i = 1; i <= 100; i++) {
                grid.appendChild(createGridRow(i, 'tourism'));
            }
            
            // Set up real-time dashboard updates
            setupDashboardUpdates();
            
            // Initial update of sales lead filter
            updateSalesLeadFilter();
        }

        // Function to add more rows (21 additional rows when clicked)
        function addMoreRows(sectorName) {
            const extraGrid = document.getElementById(`${sectorName}-extra-grid`);
            const moreBtn = document.getElementById(`${sectorName}-more-btn`);
            
            if (extraGrid.style.display === 'none') {
                // Show extra rows
                extraGrid.style.display = 'block';
                
                // Create 20 additional rows (101-120)
                for (let i = 101; i <= 120; i++) {
                    extraGrid.appendChild(createGridRow(i, sectorName));
                }
                
                moreBtn.textContent = 'Hide Extra';
                moreBtn.style.background = '#e74c3c';
            } else {
                // Hide extra rows
                extraGrid.style.display = 'none';
                extraGrid.innerHTML = ''; // Clear the extra rows
                moreBtn.textContent = 'More';
                moreBtn.style.background = '#9b59b6';
            }
            
            // Update dashboard after adding/removing rows
            updateDashboard();
        }

        // Dashboard update functions
        function setupDashboardUpdates() {
            // Update dashboard every 2 seconds
            setInterval(updateDashboard, 2000);
            updateDashboard(); // Initial update
            
            // Auto-save trigger on data changes
            setupAutoSaveTriggers();
            
            // Update sales lead filter when data changes
            setupFilterUpdates();
        }

        function setupFilterUpdates() {
            // Update filter options when sales lead data changes
            document.addEventListener('input', function(e) {
                if (e.target.id && e.target.id.includes('saleslead')) {
                    // Debounce filter updates
                    clearTimeout(window.filterUpdateTimeout);
                    window.filterUpdateTimeout = setTimeout(updateSalesLeadFilter, 500);
                }
            });
            
            // Also update filter when data is pasted or changed in other ways
            document.addEventListener('change', function(e) {
                if (e.target.id && e.target.id.includes('saleslead')) {
                    clearTimeout(window.filterUpdateTimeout);
                    window.filterUpdateTimeout = setTimeout(updateSalesLeadFilter, 500);
                }
            });
            
            // Initial filter update
            updateSalesLeadFilter();
        }

        function setupAutoSaveTriggers() {
            // Add event listeners to all inputs to trigger auto-save
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, select')) {
                    // Debounce the save operation
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(() => {
                        if (database) {
                            autoSaveToFirebase();
                        }
                    }, 3000); // Save 3 seconds after user stops typing
                }
            });

            // Also trigger on button clicks
            document.addEventListener('click', function(e) {
                if (e.target.matches('.btn-small, .outcome-select')) {
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(() => {
                        if (database) {
                            autoSaveToFirebase();
                        }
                    }, 1000); // Save 1 second after button click
                }
            });
        }

        function updateDashboard() {
            let totalActive = 0;
            let bootcampCounts = { 'Bootcamp': 0, 'Prince 2': 0, 'AI': 0, 'Microsoft': 0 };
            let communicationCounts = { emails: 0, calls: 0 };
            let outcomeCounts = { 
                'Confirmed': 0, 'Rejected': 0, 'Interview': 0, 
                'Waitlist': 0, 'Pending': 0, 'No Response': 0 
            };
            let completionCounts = { email: 0, phone: 0, notes: 0, complete: 0 };

            // Check both main grid (1-100) and extra grid (101-120)
            for (let i = 1; i <= 120; i++) {
                const company = document.getElementById(`tourism-company-${i}`);
                const contact = document.getElementById(`tourism-contact-${i}`);
                const email = document.getElementById(`tourism-email-${i}`);
                const phone = document.getElementById(`tourism-phone-${i}`);
                const notes = document.getElementById(`tourism-notes-${i}`);

                // Check if this row is currently visible by checking the parent grid row
                let isVisible = true;
                if (company) {
                    const parentRow = company.closest('.grid-row');
                    isVisible = parentRow && parentRow.style.display !== 'none';
                }

                // Check if this is an active contact (has company or contact name) AND is visible
                if (company && contact && (company.value.trim() || contact.value.trim()) && isVisible) {
                    totalActive++;

                    // Count bootcamp types
                    const bootcampBtn = document.getElementById(`tourism-bootcamp-${i}`);
                    if (bootcampBtn) {
                        const bootcampType = bootcampBtn.textContent;
                        if (bootcampCounts.hasOwnProperty(bootcampType)) {
                            bootcampCounts[bootcampType]++;
                        }
                    }

                    // Count communications
                    const emailBtn = document.getElementById(`tourism-email-btn-${i}`);
                    const callBtn = document.getElementById(`tourism-call-btn-${i}`);

                    if (emailBtn && emailBtn.textContent === 'Sent') {
                        communicationCounts.emails++;
                    }
                    if (callBtn && callBtn.textContent === 'Called') {
                        communicationCounts.calls++;
                    }

                    // Count outcomes
                    const outcomeSelect = document.getElementById(`tourism-outcome-${i}`);
                    if (outcomeSelect && outcomeSelect.value) {
                        outcomeCounts[outcomeSelect.value]++;
                    }

                    // Count completion stats
                    if (email && email.value.trim()) completionCounts.email++;
                    if (phone && phone.value.trim()) completionCounts.phone++;
                    if (notes && notes.value.trim()) completionCounts.notes++;
                    
                    // Complete profile: has company/contact, email, and phone
                    if ((company.value.trim() || contact.value.trim()) && 
                        email && email.value.trim() && 
                        phone && phone.value.trim()) {
                        completionCounts.complete++;
                    }
                }
            }

            // Update dashboard displays - with null checks
            const activeContactsEl = document.getElementById('active-contacts');
            if (activeContactsEl) activeContactsEl.textContent = totalActive;
            
            const bootcampCountEl = document.getElementById('bootcamp-count');
            if (bootcampCountEl) bootcampCountEl.textContent = bootcampCounts['Bootcamp'];
            
            const prince2CountEl = document.getElementById('prince2-count');
            if (prince2CountEl) prince2CountEl.textContent = bootcampCounts['Prince 2'];
            
            const aiCountEl = document.getElementById('ai-count');
            if (aiCountEl) aiCountEl.textContent = bootcampCounts['AI'];
            
            const microsoftCountEl = document.getElementById('microsoft-count');
            if (microsoftCountEl) microsoftCountEl.textContent = bootcampCounts['Microsoft'];

            const emailsSentEl = document.getElementById('emails-sent');
            if (emailsSentEl) emailsSentEl.textContent = communicationCounts.emails;
            
            const callsMadeEl = document.getElementById('calls-made');
            if (callsMadeEl) callsMadeEl.textContent = communicationCounts.calls;

            const confirmedCountEl = document.getElementById('confirmed-count');
            if (confirmedCountEl) confirmedCountEl.textContent = outcomeCounts['Confirmed'];
            
            const rejectedCountEl = document.getElementById('rejected-count');
            if (rejectedCountEl) rejectedCountEl.textContent = outcomeCounts['Rejected'];
            
            const interviewCountEl = document.getElementById('interview-count');
            if (interviewCountEl) interviewCountEl.textContent = outcomeCounts['Interview'];
            
            const waitlistCountEl = document.getElementById('waitlist-count');
            if (waitlistCountEl) waitlistCountEl.textContent = outcomeCounts['Waitlist'];
            
            const pendingCountEl = document.getElementById('pending-count');
            if (pendingCountEl) pendingCountEl.textContent = outcomeCounts['Pending'];
            
            const noResponseCountEl = document.getElementById('no-response-count');
            if (noResponseCountEl) noResponseCountEl.textContent = outcomeCounts['No Response'];

            const withEmailEl = document.getElementById('with-email');
            if (withEmailEl) withEmailEl.textContent = completionCounts.email;
            
            const withPhoneEl = document.getElementById('with-phone');
            if (withPhoneEl) withPhoneEl.textContent = completionCounts.phone;
            
            const withNotesEl = document.getElementById('with-notes');
            if (withNotesEl) withNotesEl.textContent = completionCounts.notes;
            
            const completeProfilesEl = document.getElementById('complete-profiles');
            if (completeProfilesEl) completeProfilesEl.textContent = completionCounts.complete;

            // Calculate success rate
            const totalOutcomes = Object.values(outcomeCounts).reduce((a, b) => a + b, 0);
            const successfulOutcomes = outcomeCounts['Confirmed'] + outcomeCounts['Interview'];
            const successRate = totalOutcomes > 0 ? Math.round((successfulOutcomes / totalOutcomes) * 100) : 0;
            
            const successRateEl = document.getElementById('success-rate');
            if (successRateEl) successRateEl.textContent = successRate + '%';
        }

        function createGridRow(index, sectorName) {
            const rowContainer = document.createElement('div');
            
            // Main data row
            const row = document.createElement('div');
            row.className = 'grid-row';
            row.innerHTML = `
                <div class="grid-cell">${index}</div>
                <div class="grid-cell">
                    <input type="text" placeholder="Sales Lead" id="${sectorName}-saleslead-${index}">
                </div>
                <div class="grid-cell">
                    <input type="text" placeholder="Industry" id="${sectorName}-industry-${index}">
                </div>
                <div class="grid-cell">
                    <input type="text" placeholder="Company Name" id="${sectorName}-company-${index}">
                </div>
                <div class="grid-cell">
                    <input type="text" placeholder="Contact Person" id="${sectorName}-contact-${index}">
                </div>
                <div class="grid-cell">
                    <div class="contact-field">
                        <input type="tel" placeholder="Phone Number" id="${sectorName}-phone-${index}">
                        <button class="copy-btn" onclick="copyToClipboard('${sectorName}-phone-${index}', this)" title="Copy Phone">📞</button>
                    </div>
                </div>
                <div class="grid-cell">
                    <div class="contact-field">
                        <input type="email" placeholder="Email Address" id="${sectorName}-email-${index}">
                        <button class="copy-btn" onclick="copyToClipboard('${sectorName}-email-${index}', this)" title="Copy Email">📧</button>
                    </div>
                </div>
                <div class="grid-cell">
                    <input type="text" placeholder="Region" id="${sectorName}-region-${index}">
                </div>
            `;

            // Actions row (Bootcamp, Email, Call, Outcome)
            const actionsRow = document.createElement('div');
            actionsRow.className = 'actions-row';
            actionsRow.innerHTML = `
                <div></div>
                <div class="grid-cell">
                    <button class="btn-small btn-bootcamp" onclick="toggleBootcamp(this)" id="${sectorName}-bootcamp-${index}">Bootcamp</button>
                </div>
                <div class="grid-cell">
                    <button class="btn-small btn-email" onclick="toggleEmail(this)" id="${sectorName}-email-btn-${index}">Send</button>
                </div>
                <div class="grid-cell">
                    <button class="btn-small btn-call" onclick="toggleCall(this)" id="${sectorName}-call-btn-${index}">Call</button>
                </div>
                <div class="grid-cell">
                    <select class="outcome-select" onchange="updateOutcomeColor(this)" id="${sectorName}-outcome-${index}">
                        <option value="">- Outcome -</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Interview">Interview</option>
                        <option value="Waitlist">Waitlist</option>
                        <option value="Pending">Pending</option>
                        <option value="No Response">No Response</option>
                    </select>
                </div>
                <div></div>
            `;

            // Notes row
            const notesRow = document.createElement('div');
            notesRow.className = 'notes-row';
            // Remove border for notes row of row 100
            if (index === 100) {
                notesRow.classList.add('no-border');
                actionsRow.classList.add('no-border');
            }
            notesRow.innerHTML = `
                <div></div>
                <div style="color: #7f8c8d; font-size: 0.8em; font-weight: 600; width: fit-content;">Notes:</div>
                <div class="grid-cell" style="padding-left: 0;">
                    <input type="text" placeholder="Add notes..." id="${sectorName}-notes-${index}" style="width: 100%; border: 1px solid #bdc3c7;">
                </div>
            `;

            rowContainer.appendChild(row);
            rowContainer.appendChild(actionsRow);
            rowContainer.appendChild(notesRow);
            return rowContainer;
        }

        function updateOutcomeColor(selectElement) {
            const actionsRow = selectElement.closest('.actions-row');
            const value = selectElement.value.toLowerCase().replace(' ', '-');
            
            // Remove all outcome classes
            actionsRow.classList.remove('outcome-confirmed', 'outcome-rejected', 'outcome-interview', 
                              'outcome-waitlist', 'outcome-pending', 'outcome-no-response');
            
            // Add the appropriate class
            if (value) {
                actionsRow.classList.add(`outcome-${value}`);
            }
            
            // Trigger dashboard update
            updateDashboard();
        }

        function toggleBootcamp(button) {
            const options = ['Bootcamp', 'Prince 2', 'AI', 'Microsoft'];
            const currentIndex = options.indexOf(button.textContent);
            const nextIndex = (currentIndex + 1) % options.length;
            button.textContent = options[nextIndex];
            
            // Color coding for different bootcamp types
            const colors = ['#8e44ad', '#e74c3c', '#3498db', '#27ae60'];
            button.style.background = colors[nextIndex];
            
            // Trigger dashboard update
            updateDashboard();
        }

        function toggleEmail(button) {
            if (button.textContent === 'Send') {
                button.textContent = 'Sent';
                button.style.background = '#f39c12';
            } else {
                button.textContent = 'Send';
                button.style.background = '#2ecc71';
            }
            
            // Trigger dashboard update
            updateDashboard();
        }

        function toggleCall(button) {
            if (button.textContent === 'Call') {
                button.textContent = 'Called';
                button.style.background = '#27ae60';
            } else {
                button.textContent = 'Call';
                button.style.background = '#f39c12';
            }
            
            // Trigger dashboard update
            updateDashboard();
        }

        function exportAllToCSV() {
            let csvContent = 'Sector,#,Sales Lead,Industry,Company Name,Contact Person,Phone,Email,Region,Bootcamp,Email Status,Call Status,Outcome,Notes\n';
            
            for (let i = 1; i <= 120; i++) {
                const salesLead = document.getElementById(`tourism-saleslead-${i}`)?.value || '';
                const industry = document.getElementById(`tourism-industry-${i}`)?.value || '';
                const company = document.getElementById(`tourism-company-${i}`)?.value || '';
                const contact = document.getElementById(`tourism-contact-${i}`)?.value || '';
                const phone = document.getElementById(`tourism-phone-${i}`)?.value || '';
                const email = document.getElementById(`tourism-email-${i}`)?.value || '';
                const region = document.getElementById(`tourism-region-${i}`)?.value || '';
                const notes = document.getElementById(`tourism-notes-${i}`)?.value || '';
                
                const bootcampBtn = document.getElementById(`tourism-bootcamp-${i}`);
                const emailBtn = document.getElementById(`tourism-email-btn-${i}`);
                const callBtn = document.getElementById(`tourism-call-btn-${i}`);
                const outcomeSelect = document.getElementById(`tourism-outcome-${i}`);
                
                const bootcamp = bootcampBtn ? bootcampBtn.textContent : 'Bootcamp';
                const emailStatus = emailBtn ? emailBtn.textContent : 'Send';
                const callStatus = callBtn ? callBtn.textContent : 'Call';
                const outcome = outcomeSelect ? outcomeSelect.value : '';

                // Only export rows with data
                if (company || contact || email || phone) {
                    csvContent += `"Tourism","${i}","${salesLead}","${industry}","${company}","${contact}","${phone}","${email}","${region}","${bootcamp}","${emailStatus}","${callStatus}","${outcome}","${notes}"\n`;
                }
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `rob_cornwall_business_tracker_v3_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                const inputs = document.querySelectorAll('input');
                const selects = document.querySelectorAll('select');
                const buttons = document.querySelectorAll('.btn-small');
                
                inputs.forEach(input => input.value = '');
                selects.forEach(select => select.selectedIndex = 0);
                
                buttons.forEach(button => {
                    if (button.classList.contains('btn-bootcamp')) {
                        button.textContent = 'Bootcamp';
                        button.style.background = '#8e44ad';
                    } else if (button.classList.contains('btn-email')) {
                        button.textContent = 'Send';
                        button.style.background = '#2ecc71';
                    } else if (button.classList.contains('btn-call')) {
                        button.textContent = 'Call';
                        button.style.background = '#f39c12';
                    }
                });

                // Remove outcome color classes
                const actionsRows = document.querySelectorAll('.actions-row');
                actionsRows.forEach(row => {
                    row.classList.remove('outcome-confirmed', 'outcome-rejected', 'outcome-interview', 
                                      'outcome-waitlist', 'outcome-pending', 'outcome-no-response');
                });
                
                // Update dashboard after clearing
                updateDashboard();
            }
        }

        // FIXED CSV UPLOAD FUNCTION
        function uploadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                
                let rowNumber = 1;
                
                // Skip header row and process data
                for (let i = 1; i < lines.length && rowNumber <= 120; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV line properly handling quoted values
                    const values = parseCSVLine(line);
                    
                    if (values.length >= 15) {
                        // Map CSV columns to form fields based on your CSV structure:
                        // Sales Lead,Industry/Sector,Company Name,Phone,Contact Name,Contact Email,Contact Tel,Bootcamp,Region,Email sent,Spoke,Action/Comments,Chase/Follow up,Outcome,Notes
                        const salesLead = values[0] || '';
                        const industry = values[1] || '';
                        const company = values[2] || '';
                        const csvPhone = values[3] || '';
                        const contact = values[4] || '';
                        const email = values[5] || '';
                        const contactTel = values[6] || '';
                        const bootcamp = values[7] || 'Bootcamp';
                        const region = values[8] || '';
                        const emailSent = values[9] || '';
                        const spoke = values[10] || '';
                        const actionComments = values[11] || '';
                        const chaseFollowUp = values[12] || '';
                        const outcome = values[13] || '';
                        const notes = values[14] || '';

                        // Use the phone number from the most appropriate field
                        const phone = contactTel || csvPhone;

                        // Fill in the data
                        const salesLeadInput = document.getElementById(`tourism-saleslead-${rowNumber}`);
                        const industryInput = document.getElementById(`tourism-industry-${rowNumber}`);
                        const companyInput = document.getElementById(`tourism-company-${rowNumber}`);
                        const contactInput = document.getElementById(`tourism-contact-${rowNumber}`);
                        const phoneInput = document.getElementById(`tourism-phone-${rowNumber}`);
                        const emailInput = document.getElementById(`tourism-email-${rowNumber}`);
                        const regionInput = document.getElementById(`tourism-region-${rowNumber}`);
                        const notesInput = document.getElementById(`tourism-notes-${rowNumber}`);
                        
                        if (salesLeadInput) salesLeadInput.value = salesLead;
                        if (industryInput) industryInput.value = industry;
                        if (companyInput) companyInput.value = company;
                        if (contactInput) contactInput.value = contact;
                        if (phoneInput) phoneInput.value = phone;
                        if (emailInput) emailInput.value = email;
                        if (regionInput) regionInput.value = region;
                        
                        // Combine notes from multiple fields
                        let combinedNotes = '';
                        if (notes) combinedNotes += notes;
                        if (actionComments) combinedNotes += (combinedNotes ? ' | ' : '') + 'Action: ' + actionComments;
                        if (chaseFollowUp) combinedNotes += (combinedNotes ? ' | ' : '') + 'Follow-up: ' + chaseFollowUp;
                        
                        if (notesInput) notesInput.value = combinedNotes;
                        
                        // Set button states
                        const bootcampBtn = document.getElementById(`tourism-bootcamp-${rowNumber}`);
                        if (bootcampBtn && bootcamp) {
                            const bootcampOptions = ['Bootcamp', 'Prince 2', 'AI', 'Microsoft'];
                            const bootcampText = bootcampOptions.includes(bootcamp) ? bootcamp : 'Bootcamp';
                            bootcampBtn.textContent = bootcampText;
                            const bootcampColors = { 'Bootcamp': '#8e44ad', 'Prince 2': '#e74c3c', 'AI': '#3498db', 'Microsoft': '#27ae60' };
                            bootcampBtn.style.background = bootcampColors[bootcampText] || '#8e44ad';
                        }
                        
                        const emailBtn = document.getElementById(`tourism-email-btn-${rowNumber}`);
                        if (emailBtn && emailSent) {
                            const emailStatus = (emailSent.toLowerCase() === 'yes' || emailSent.toLowerCase() === 'sent') ? 'Sent' : 'Send';
                            emailBtn.textContent = emailStatus;
                            emailBtn.style.background = emailStatus === 'Sent' ? '#f39c12' : '#2ecc71';
                        }
                        
                        const callBtn = document.getElementById(`tourism-call-btn-${rowNumber}`);
                        if (callBtn && spoke) {
                            const callStatus = (spoke.toLowerCase() === 'yes' || spoke.toLowerCase() === 'called') ? 'Called' : 'Call';
                            callBtn.textContent = callStatus;
                            callBtn.style.background = callStatus === 'Called' ? '#27ae60' : '#f39c12';
                        }
                        
                        // Set outcome if provided
                        if (outcome) {
                            const outcomeSelect = document.getElementById(`tourism-outcome-${rowNumber}`);
                            if (outcomeSelect) {
                                const outcomeOptions = ['Confirmed', 'Rejected', 'Interview', 'Waitlist', 'Pending', 'No Response'];
                                const outcomeValue = outcomeOptions.find(opt => opt.toLowerCase() === outcome.toLowerCase()) || '';
                                if (outcomeValue) {
                                    outcomeSelect.value = outcomeValue;
                                    updateOutcomeColor(outcomeSelect);
                                }
                            }
                        }
                        
                        rowNumber++;
                    }
                }
                
                // Update dashboard after upload
                updateDashboard();
                
                // Update filter options after CSV upload
                setTimeout(updateSalesLeadFilter, 1000);
                
                alert(`CSV uploaded successfully! Imported ${rowNumber - 1} rows.`);
            };
            
            reader.readAsText(file);
        }

        // Helper function to parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Don't forget the last field
            result.push(current.trim());
            
            return result;
        }

        // New comprehensive sort function
        function sortData() {
            const field = document.getElementById('sort-field').value;
            
            if (!field) {
                alert('Please select a field to sort by.');
                return;
            }
            
            const grid = document.getElementById('tourism-grid');
            if (!grid) return;

            // Get all rows (each row = 3 divs: data + actions + notes)
            const children = Array.from(grid.children);
            const rowGroups = [];

            for (let i = 0; i < children.length; i += 3) {
                if (children[i + 1] && children[i + 2]) {
                    const rowNum = Math.floor(i / 3) + 1;
                    const rowData = {
                        dataRow: children[i],
                        actionsRow: children[i + 1],
                        notesRow: children[i + 2],
                        index: rowNum
                    };
                    
                    // Get the field value for sorting
                    if (field === 'outcome') {
                        const outcomeSelect = document.getElementById(`tourism-outcome-${rowNum}`);
                        rowData.sortValue = outcomeSelect?.value || '';
                    } else {
                        const fieldInput = document.getElementById(`tourism-${field}-${rowNum}`);
                        rowData.sortValue = fieldInput?.value?.toLowerCase() || '';
                    }
                    
                    rowGroups.push(rowData);
                }
            }

            // Sort by the selected field
            rowGroups.sort((a, b) => {
                // Put empty values at the end
                if (!a.sortValue && b.sortValue) return 1;
                if (a.sortValue && !b.sortValue) return -1;
                return a.sortValue.localeCompare(b.sortValue);
            });

            // Clear and re-append in sorted order
            grid.innerHTML = '';
            rowGroups.forEach(group => {
                grid.appendChild(group.dataRow);
                grid.appendChild(group.actionsRow);
                grid.appendChild(group.notesRow);
            });

            updateDashboard();
            alert(`Tourism sorted by ${field}`);
        }

        // Reset to original order (by row number)
        function resetSort() {
            const grid = document.getElementById('tourism-grid');
            if (!grid) return;

            // Get all rows
            const children = Array.from(grid.children);
            const rowGroups = [];

            for (let i = 0; i < children.length; i += 3) {
                if (children[i + 1] && children[i + 2]) {
                    const rowNum = Math.floor(i / 3) + 1;
                    rowGroups.push({
                        dataRow: children[i],
                        actionsRow: children[i + 1],
                        notesRow: children[i + 2],
                        index: rowNum
                    });
                }
            }

            // Sort by index (original order)
            rowGroups.sort((a, b) => a.index - b.index);

            // Clear and re-append in original order
            grid.innerHTML = '';
            rowGroups.forEach(group => {
                grid.appendChild(group.dataRow);
                grid.appendChild(group.actionsRow);
                grid.appendChild(group.notesRow);
            });

            // Show all rows after sorting
            showAllRows();
            updateDashboard();
        }

        // Sales Lead Filter Functions
        function updateSalesLeadFilter() {
            const filterSelect = document.getElementById('filter-saleslead');
            if (!filterSelect) return;
            
            const salesLeads = new Set();
            
            // Collect all unique sales leads from both main and extra grids
            for (let i = 1; i <= 120; i++) {
                const salesLeadInput = document.getElementById(`tourism-saleslead-${i}`);
                if (salesLeadInput && salesLeadInput.value.trim()) {
                    salesLeads.add(salesLeadInput.value.trim());
                }
            }
            
            // Store current selection to preserve it if possible
            const currentSelection = filterSelect.value;
            
            // Clear existing options except "Show All"
            filterSelect.innerHTML = '<option value="">Show All Sales Leads</option>';
            
            // Add unique sales leads to filter
            const sortedLeads = Array.from(salesLeads).sort();
            sortedLeads.forEach(salesLead => {
                const option = document.createElement('option');
                option.value = salesLead;
                option.textContent = salesLead;
                filterSelect.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentSelection && sortedLeads.includes(currentSelection)) {
                filterSelect.value = currentSelection;
            }
            
            console.log('Sales lead filter updated with:', sortedLeads);
        }

        function applyFilter() {
            const selectedSalesLead = document.getElementById('filter-saleslead').value;
            const filterIndicator = document.getElementById('filter-indicator');
            
            if (!selectedSalesLead) {
                // Show all rows if no filter selected
                showAllRows();
                filterIndicator.textContent = '';
                return;
            }
            
            // Update filter indicator
            filterIndicator.textContent = `Showing: ${selectedSalesLead}`;
            
            console.log(`Filtering for sales lead: "${selectedSalesLead}"`);
            
            const grid = document.getElementById('tourism-grid');
            const extraGrid = document.getElementById('tourism-extra-grid');
            
            // Filter main grid
            filterGridRows(grid, selectedSalesLead);
            
            // Filter extra grid if visible
            if (extraGrid.style.display !== 'none') {
                filterGridRows(extraGrid, selectedSalesLead);
            }
            
            // Force dashboard update after filtering
            setTimeout(() => {
                updateDashboard();
                console.log('Dashboard updated after filtering');
            }, 100);
        }

        function filterGridRows(grid, selectedSalesLead) {
            const children = Array.from(grid.children);
            
            for (let i = 0; i < children.length; i += 3) {
                const dataRow = children[i];
                const actionsRow = children[i + 1];
                const notesRow = children[i + 2];
                
                if (dataRow && actionsRow && notesRow) {
                    // Find the sales lead input in this row
                    const salesLeadInput = dataRow.querySelector('input[id*="saleslead"]');
                    const salesLeadValue = salesLeadInput ? salesLeadInput.value.trim() : '';
                    
                    // Debug logging
                    if (salesLeadValue) {
                        console.log(`Row ${Math.floor(i/3) + 1}: "${salesLeadValue}" === "${selectedSalesLead}"? ${salesLeadValue === selectedSalesLead}`);
                    }
                    
                    // EXACT match only - not partial match
                    if (salesLeadValue === selectedSalesLead) {
                        dataRow.style.display = 'grid';
                        actionsRow.style.display = 'grid';
                        notesRow.style.display = 'grid';
                    } else {
                        dataRow.style.display = 'none';
                        actionsRow.style.display = 'none';
                        notesRow.style.display = 'none';
                    }
                }
            }
        }

        function showAllRows() {
            const grid = document.getElementById('tourism-grid');
            const extraGrid = document.getElementById('tourism-extra-grid');
            
            // Show all rows in main grid
            showAllGridRows(grid);
            
            // Show all rows in extra grid if visible
            if (extraGrid.style.display !== 'none') {
                showAllGridRows(extraGrid);
            }
            
            updateDashboard();
        }

        function showAllGridRows(grid) {
            const children = Array.from(grid.children);
            
            children.forEach(child => {
                child.style.display = 'grid';
            });
        }

        function resetView() {
            // Reset filter dropdown
            document.getElementById('filter-saleslead').value = '';
            
            // Clear filter indicator
            document.getElementById('filter-indicator').textContent = '';
            
            // Show all rows
            showAllRows();
            
            // Reset sort order
            resetSort();
            
            alert('View reset - showing all rows in original order');
        }

        // Copy to clipboard function
        function copyToClipboard(inputId, buttonElement) {
            const input = document.getElementById(inputId);
            if (!input || !input.value.trim()) {
                // Flash red if empty
                buttonElement.style.background = '#e74c3c';
                setTimeout(() => {
                    buttonElement.style.background = '#95a5a6';
                }, 300);
                return;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(input.value).then(() => {
                // Success feedback
                const originalText = buttonElement.textContent;
                const originalBg = buttonElement.style.background;
                
                buttonElement.textContent = '✓';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                    buttonElement.style.background = originalBg;
                }, 1000);
            }).catch(err => {
                // Fallback for older browsers
                input.select();
                input.setSelectionRange(0, 99999);
                document.execCommand('copy');
                
                // Success feedback
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '✓';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 1000);
            });
        }

        // Initialize the page when it loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeGrids();
            initializeFirebase();
        });
    </script>
</body>
</html>
